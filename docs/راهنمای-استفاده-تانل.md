# راهنمای استفاده از تانل (مثل ngrok)

آدرس ثابت Webhook همیشه این است: **https://webhook.abroadqs.com/webhook**

---

## حالت ۱: ربات روی سرور پابلیش است (استفاده عادی)

1. روی سرور دو تا سرویس باید بالا باشند:
   - **ربات** روی پورت 5252
   - **Tunnel Server** روی پورت 9080 (و nginx به 9080 فوروارد کند)

2. در **داشبورد** ربات (`/dashboard`):
   - گزینه **«روی سرور (پابلیش)»** را بزن.
   - در فیلد Webhook URL بنویس: `https://webhook.abroadqs.com/webhook`
   - دکمه **«Set webhook»** را بزن.

3. اگر می‌خواهی با استارت برنامه خودکار Webhook ست شود، در `appsettings.json` یا متغیر محیطی روی سرور بگذار:
   - `Telegram:PublicWebhookUrl` = `https://webhook.abroadqs.com/webhook`  
   یا  
   - `PUBLIC_WEBHOOK_URL` = `https://webhook.abroadqs.com/webhook`

از این به بعد تلگرام به همین آدرس درخواست می‌فرستد و چون Tunnel Client وصل نیست، سرور درخواست را به ربات روی 5252 می‌دهد.

---

## حالت ۲: ربات لوکال است (توسعه) — استفاده از تانل

### با ویژوال استودیو (یک کلیک)

1. پروژه **AbroadQs.Bot.Host.Webhook** را به‌عنوان Startup قرار بده.
2. از لیست پروفایل‌های اجرا (کنار دکمهٔ سبز Run) پروفایل **«http (with tunnel - local)»** را انتخاب کن.
3. **F5** یا Run بزن. خودش اول Tunnel Client را بالا می‌آورد، بعد ربات را اجرا می‌کند (با `ASPNETCORE_URLS=http://127.0.0.1:5252`).

### با خط فرمان

1. **ربات را لوکال اجرا کن** (مثلاً روی پورت 5252):
   ```bash
   cd C:\Users\pc\Desktop\ServerSetup\AbroadQs.TelegramBot
   dotnet run --project src/AbroadQs.Bot.Host.Webhook
   ```

2. **Tunnel Client را اجرا کن** (در یک ترمینال دیگر):
   ```bash
   cd C:\Users\pc\Desktop\ServerSetup\AbroadQs.TelegramBot
   dotnet run --project src/AbroadQs.TunnelClient -- --url https://webhook.abroadqs.com --local 5252
   ```
   وقتی ببینی `Connected. Forwarding requests to localhost:5252...` یعنی تانل وصل است.

3. در **داشبورد** (لوکال یا روی سرور):
   - گزینه **«تانل (مثل ngrok)»** را بزن.
   - فیلد Webhook URL خودکار می‌شود: `https://webhook.abroadqs.com/webhook`
   - **«Set webhook»** را بزن.

از این به بعد تلگرام به همان آدرس درخواست می‌فرستد؛ درخواست از سرور به Tunnel Client تو می‌رسد و به ربات لوکال (5252) فوروارد می‌شود.

---

## خلاصه

| وضعیت              | کار تو |
|--------------------|--------|
| **پابلیش روی سرور** | ربات + Tunnel Server روی سرور بالا باشند؛ در داشبورد «روی سرور» و آدرس `https://webhook.abroadqs.com/webhook` را ست کن. |
| **توسعه لوکال**     | ربات لوکال را اجرا کن؛ Tunnel Client را با `--url https://webhook.abroadqs.com --local 5252` اجرا کن؛ در داشبورد «تانل» را بزن و Set webhook. |

همیشه همان یک آدرس: **https://webhook.abroadqs.com/webhook**
