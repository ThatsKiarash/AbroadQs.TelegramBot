<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Bot Operations - AbroadQs</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="/css/site.css" />
</head>
<body class="dashboard-body">
    <div class="dashboard-wrapper">
        <aside class="dashboard-sidebar" id="dashboardSidebar">
            <div class="sidebar-brand">ABROADQS OPS</div>
            <nav class="nav flex-column sidebar-nav">
                <a href="#" class="nav-link" data-tab="bot-operations">Overview</a>
                <a href="#" class="nav-link active" data-tab="users">Users</a>
                <a href="#" class="nav-link" data-tab="kyc">Identity Verification</a>
                <a href="#" class="nav-link">Identity Settings</a>
                <a href="#" class="nav-link">Tickets</a>
                <a href="#" class="nav-link">Exchange Rates</a>
                <a href="#" class="nav-link">Exchange Requests</a>
                <a href="#" class="nav-link">User Wallets</a>
                <a href="#" class="nav-link">Master Wallet</a>
                <a href="#" class="nav-link">System Fees</a>
                <a href="#" class="nav-link" data-tab="bot-operations">Bot Operations</a>
                <a href="#" class="nav-link" data-tab="stages">Bot Stages</a>
                <a href="#" class="nav-link" data-tab="permissions">Permissions</a>
                <a href="#" class="nav-link">Channel Settings</a>
                <a href="#" class="nav-link">Channel Posts</a>
                <a href="#" class="nav-link">Analytics</a>
            </nav>
        </aside>
        <div class="sidebar-backdrop" id="sidebarBackdrop" aria-hidden="true"></div>
        <div class="dashboard-content">
            <header class="dashboard-topbar">
                <button class="btn btn-outline-primary d-lg-none sidebar-toggle" type="button" id="sidebarToggle" aria-label="Menu">Menu</button>
                <div class="topbar-title">Support Control Center</div>
                <div class="topbar-actions">
                    <span class="text-muted">Telegram Bot Dashboard</span>
                </div>
            </header>
            <main class="dashboard-main">
                <section class="dashboard-section" id="section-users" style="display: block;">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <div>
                            <h1 class="h4 mb-1">Bot Users</h1>
                            <p class="text-muted mb-0">Users who have interacted with the Telegram bot.</p>
                        </div>
                        <button type="button" class="btn btn-sm btn-outline-primary" id="btnRefreshUsers">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrow-clockwise" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2v1z"/><path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466z"/></svg> Refresh
                        </button>
                    </div>
                    <div class="card shadow-sm">
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-sm table-hover mb-0">
                                    <thead class="table-dark">
                                        <tr>
                                            <th>Telegram ID</th>
                                            <th>Username</th>
                                            <th>First Name</th>
                                            <th>Last Name</th>
                                            <th>First Seen</th>
                                            <th>Last Seen</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="usersTableBody">
                                        <tr><td colspan="7" class="text-center text-muted">Loading...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </section>
                <section class="dashboard-section" id="section-bot-operations" style="display: none;">
                    <div class="d-flex flex-column flex-lg-row justify-content-between gap-3 mb-4">
                        <div>
                            <h1 class="h4 mb-1">Telegram Bot Management</h1>
                            <p class="text-muted mb-0">Store credentials, sync webhook endpoints, and validate connectivity.</p>
                        </div>
                        <div class="text-muted small" id="webhookSyncedLabel"></div>
                    </div>

                    <div class="row g-4">
                        <div class="col-12 col-xl-7">
                            <div class="card shadow-sm">
                                <div class="card-body">
                                    <h2 class="h5 mb-3">Credentials</h2>
                                    <form id="credentialsForm" class="vstack gap-3 mb-3">
                                        <div>
                                            <label for="botToken" class="form-label">Bot Token</label>
                                            <div class="input-group">
                                                <input type="password" id="botToken" class="form-control" autocomplete="off" placeholder="123456789:ABCdef..." aria-label="Bot token" />
                                                <button type="button" class="btn btn-outline-secondary" id="btnToggleTokenVisibility" title="Show / hide token" aria-label="Toggle token visibility">
                                                    <svg id="iconTokenEye" xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16"><path d="M16 8s-3-5.5-8-5.5S0 8 0 8s3 5.5 8 5.5S16 8 16 8zM1.173 8a13.133 13.133 0 0 1 1.66-2.043C4.12 4.668 5.88 3.5 8 3.5c2.12 0 3.879 1.168 5.168 2.457A13.133 13.133 0 0 1 14.828 8c-.058.087-.122.183-.195.288-.335.48-.83 1.12-1.465 1.755C11.879 11.332 10.119 12.5 8 12.5c-2.12 0-3.879-1.168-5.168-2.457A13.134 13.134 0 0 1 1.172 8z"/><path d="M8 5.5a2.5 2.5 0 1 0 0 5 2.5 2.5 0 0 0 0-5zM4.5 8a3.5 3.5 0 1 1 7 0 3.5 3.5 0 0 1-7 0z"/></svg>
                                                    <svg id="iconTokenEyeSlash" xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16" style="display:none;"><path d="M13.359 11.238C15.06 9.72 16 8 16 8s-3-5.5-8-5.5a7.028 7.028 0 0 0-2.79.588l.77.771A5.944 5.944 0 0 1 8 3.5c2.12 0 3.879 1.168 5.168 2.457A13.134 13.134 0 0 1 14.828 8c-.058.087-.122.183-.195.288-.335.48-.83 1.12-1.465 1.755-.165.165-.337.328-.517.486l.708.709z"/><path d="M11.297 9.176a3.5 3.5 0 0 0-4.474-4.474l.823.823a2.5 2.5 0 0 1 2.829 2.829l.82.82zM4.88 4.82a7.028 7.028 0 0 0-2.79.588l.77.771A5.944 5.944 0 0 1 8 3.5c2.12 0 3.879 1.168 5.168 2.457A13.134 13.134 0 0 1 14.828 8c-.058.087-.122.183-.195.288-.335.48-.83 1.12-1.465 1.755-.165.165-.337.328-.517.486l.708.709a7.028 7.028 0 0 0 2.79-.588l-.77-.771a5.944 5.944 0 0 1-2.829 2.829l-.77-.77z"/><path d="M3.35 5.47c-.18.16-.353.322-.518.487A13.134 13.134 0 0 0 1.172 8l.195.288c.335.48.83 1.12 1.465 1.755C4.121 11.332 5.881 12.5 8 12.5c.716 0 1.39-.133 2.02-.36l.77.772A7.029 7.029 0 0 1 8 13.5C3 13.5 0 8 0 8s.939-1.721 2.641-3.238l.708.709zm10.296 8.884-12-12 .708-.708 12 12-.708.708z"/></svg>
                                                </button>
                                            </div>
                                        </div>
                                        <div>
                                            <label class="form-label">Update mode</label>
                                            <div class="d-flex flex-wrap gap-3 mb-1">
                                                <div class="form-check form-check-inline">
                                                    <input class="form-check-input" type="radio" name="updateMode" id="updateModeWebhook" value="Webhook" />
                                                    <label class="form-check-label" for="updateModeWebhook">Webhook</label>
                                                </div>
                                                <div class="form-check form-check-inline">
                                                    <input class="form-check-input" type="radio" name="updateMode" id="updateModeGetUpdates" value="GetUpdates" />
                                                    <label class="form-check-label" for="updateModeGetUpdates">Get Updates (long polling)</label>
                                                </div>
                                            </div>
                                            <small class="form-text text-muted">Webhook: Telegram sends updates to your URL (must be public HTTPS). Get Updates: bot polls for updates (no public URL needed). For local testing, use Get Updates so the bot receives and replies to messages. Restart required after change.</small>
                                        </div>
                                        <div>
                                            <label class="form-label">Webhook endpoint</label>
                                            <div class="d-flex flex-wrap gap-3 mb-2">
                                                <div class="form-check form-check-inline">
                                                    <input class="form-check-input" type="radio" name="webhookSource" id="webhookSourceServer" value="server" checked />
                                                    <label class="form-check-label" for="webhookSourceServer">Server (published)</label>
                                                </div>
                                                <div class="form-check form-check-inline">
                                                    <input class="form-check-input" type="radio" name="webhookSource" id="webhookSourceTunnel" value="tunnel" />
                                                    <label class="form-check-label" for="webhookSourceTunnel">Tunnel (like ngrok)</label>
                                                </div>
                                                <div class="form-check form-check-inline">
                                                    <input class="form-check-input" type="radio" name="webhookSource" id="webhookSourceNgrok" value="ngrok" />
                                                    <label class="form-check-label" for="webhookSourceNgrok">Ngrok</label>
                                                </div>
                                            </div>
                                            <input type="url" id="webhookUrl" class="form-control" autocomplete="off" placeholder="https://webhook.abroadqs.com/webhook" aria-label="Webhook URL" />
                                            <small class="form-text text-muted" id="webhookUrlHint">Webhook URL (HTTPS). For published: use your server URL.</small>
                                        </div>
                                        <div>
                                            <label for="baseUrl" class="form-label">Base URL (for Mini App)</label>
                                            <input type="url" id="baseUrl" class="form-control" autocomplete="off" placeholder="https://example.com" />
                                            <small class="form-text text-muted">Used when Webhook URL is empty. (Base URL for Mini App)</small>
                                        </div>
                                        <button type="submit" class="btn btn-primary">Save configuration</button>
                                    </form>
                                    <div class="d-flex flex-wrap gap-2">
                                        <button type="button" class="btn btn-outline-secondary" id="btnTestToken">Test token</button>
                                        <button type="button" class="btn btn-outline-primary" id="btnSetWebhook">Set webhook</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-12 col-xl-5">
                            <div class="card shadow-sm mb-3">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <h2 class="h5 mb-1">Bot Control</h2>
                                            <small class="text-muted">Start or stop bot responses</small>
                                        </div>
                                        <div class="d-flex align-items-center gap-2">
                                            <span id="botStatusLabel" class="badge bg-secondary">—</span>
                                            <button type="button" class="btn btn-success" id="btnBotToggle">
                                                <span id="btnBotToggleText">Start</span>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="card shadow-sm">
                                <div class="card-body">
                                    <h2 class="h5 mb-3">Connection Status</h2>
                                    <div id="statusCard" class="small">
                                        <div class="d-flex justify-content-between align-items-center py-2 border-bottom border-secondary border-opacity-25">
                                            <span class="text-muted">Token</span>
                                            <span id="statusToken" class="badge bg-secondary">—</span>
                                        </div>
                                        <div class="d-flex justify-content-between align-items-center py-2 border-bottom border-secondary border-opacity-25">
                                            <span class="text-muted">Update mode</span>
                                            <span id="statusUpdateMode" class="badge bg-secondary">—</span>
                                        </div>
                                        <div class="d-flex justify-content-between align-items-center py-2 border-bottom border-secondary border-opacity-25">
                                            <span class="text-muted">Webhook</span>
                                            <span id="statusWebhook" class="badge bg-secondary">—</span>
                                        </div>
                                        <div class="d-flex justify-content-between align-items-center py-2 border-bottom border-secondary border-opacity-25">
                                            <span class="text-muted">Bot</span>
                                            <span id="statusBot" class="badge bg-secondary">—</span>
                                        </div>
                                        <div class="d-flex justify-content-between align-items-center py-2 border-bottom border-secondary border-opacity-25">
                                            <span class="text-muted">Redis</span>
                                            <span id="statusRedis" class="badge bg-secondary">—</span>
                                        </div>
                                        <div class="d-flex justify-content-between align-items-center py-2 border-bottom border-secondary border-opacity-25">
                                            <span class="text-muted">RabbitMQ</span>
                                            <span id="statusRabbitMq" class="badge bg-secondary">—</span>
                                        </div>
                                        <div class="d-flex justify-content-between align-items-center py-2 border-bottom border-secondary border-opacity-25">
                                            <span class="text-muted">SQL Server</span>
                                            <span id="statusSql" class="badge bg-secondary">—</span>
                                        </div>
                                        <div class="mt-2 text-muted" id="statusBotTime" style="font-size:0.75rem;"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row g-4 mt-2">
                        <div class="col-12">
                            <div class="card shadow-sm">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h2 class="h5 mb-0">Recent Updates (Last 5)</h2>
                                    <button type="button" class="btn btn-sm btn-outline-primary" id="btnRefreshLogs">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrow-clockwise" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2v1z"/><path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466z"/></svg> Refresh
                                    </button>
                                </div>
                                <div class="card-body p-0">
                                    <div class="table-responsive">
                                        <table class="table table-sm table-hover mb-0">
                                            <thead class="table-dark">
                                                <tr>
                                                    <th style="width: 130px;">Time</th>
                                                    <th style="width: 80px;">Source</th>
                                                    <th style="width: 80px;">Status</th>
                                                    <th>Handler</th>
                                                    <th style="width: 180px;">Services</th>
                                                    <th style="width: 70px;">Reply</th>
                                                    <th style="width: 150px;">Error</th>
                                                </tr>
                                            </thead>
                                            <tbody id="webhookMessagesTable">
                                                <tr><td colspan="7" class="text-center text-muted">Loading...</td></tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Bot Stages Section -->
                <section class="dashboard-section" id="section-stages" style="display: none;">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <div>
                            <h1 class="h4 mb-1">Bot Stages</h1>
                            <p class="text-muted mb-0">Manage bot menus, screens, and their buttons dynamically.</p>
                        </div>
                        <button type="button" class="btn btn-sm btn-primary" id="btnAddStage">+ Add Stage</button>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-sm table-bordered" id="stagesTable">
                            <thead><tr><th>Key</th><th>Text (FA)</th><th>Text (EN)</th><th>Enabled</th><th>Permission</th><th>Parent</th><th>Order</th><th>Actions</th></tr></thead>
                            <tbody id="stagesBody"></tbody>
                        </table>
                    </div>
                    <hr/>
                    <div id="stageButtonsPanel" style="display:none;">
                        <h5 id="stageButtonsTitle">Buttons for: —</h5>
                        <button type="button" class="btn btn-sm btn-outline-primary mb-2" id="btnAddButton">+ Add Button</button>
                        <div class="table-responsive">
                            <table class="table table-sm table-bordered">
                                <thead><tr><th>FA</th><th>EN</th><th>Type</th><th>Callback</th><th>Target</th><th>URL</th><th>Row</th><th>Col</th><th>Enabled</th><th>Perm</th><th>Actions</th></tr></thead>
                                <tbody id="buttonsBody"></tbody>
                            </table>
                        </div>
                    </div>
                </section>

                <!-- KYC Review Section -->
                <section class="dashboard-section" id="section-kyc" style="display: none;">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <div>
                            <h1 class="h4 mb-1">Identity Verification (KYC)</h1>
                            <p class="text-muted mb-0">Review and manage user identity verification submissions.</p>
                        </div>
                        <div class="d-flex gap-2">
                            <select class="form-select form-select-sm" id="kycFilter" style="width:auto;">
                                <option value="pending">Pending Review</option>
                                <option value="all">All Submissions</option>
                            </select>
                            <button type="button" class="btn btn-sm btn-outline-primary" id="btnRefreshKyc">Refresh</button>
                        </div>
                    </div>
                    <div class="card shadow-sm">
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-sm table-hover mb-0">
                                    <thead class="table-dark">
                                        <tr>
                                            <th>User ID</th>
                                            <th>Name</th>
                                            <th>Phone</th>
                                            <th>Email</th>
                                            <th>Country</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="kycTableBody">
                                        <tr><td colspan="7" class="text-center text-muted">Loading...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- KYC Detail Modal -->
                <div class="modal fade" id="kycDetailModal" tabindex="-1" aria-hidden="true">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="kycDetailTitle">KYC Details</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body" id="kycDetailBody">
                                <div class="text-center text-muted">Loading...</div>
                            </div>
                            <div class="modal-footer" id="kycDetailFooter"></div>
                        </div>
                    </div>
                </div>

                <!-- Permissions Section -->
                <section class="dashboard-section" id="section-permissions" style="display: none;">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <div>
                            <h1 class="h4 mb-1">Permissions</h1>
                            <p class="text-muted mb-0">Define permissions and assign them to users.</p>
                        </div>
                        <button type="button" class="btn btn-sm btn-primary" id="btnAddPermission">+ Add Permission</button>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-sm table-bordered">
                            <thead><tr><th>Key</th><th>Name (FA)</th><th>Name (EN)</th><th>Description</th><th>Actions</th></tr></thead>
                            <tbody id="permissionsBody"></tbody>
                        </table>
                    </div>
                    <hr/>
                    <h5>User Permissions</h5>
                    <div class="input-group mb-3" style="max-width:400px;">
                        <input type="number" class="form-control" id="userPermUserId" placeholder="Telegram User ID"/>
                        <button class="btn btn-outline-primary" id="btnLoadUserPerms">Load</button>
                    </div>
                    <div id="userPermsPanel" style="display:none;">
                        <div class="table-responsive">
                            <table class="table table-sm table-bordered">
                                <thead><tr><th>Permission</th><th>Granted At</th><th>Actions</th></tr></thead>
                                <tbody id="userPermsBody"></tbody>
                            </table>
                        </div>
                        <div class="input-group mt-2" style="max-width:400px;">
                            <input type="text" class="form-control" id="grantPermKey" placeholder="Permission key to grant"/>
                            <button class="btn btn-success" id="btnGrantPerm">Grant</button>
                        </div>
                    </div>
                </section>

            </main>
        </div>
    </div>

    <!-- Modal for User Messages -->
    <div class="modal fade" id="messagesModal" tabindex="-1" aria-labelledby="messagesModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="messagesModalLabel">User Messages</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="messagesModalContent">
                        <div class="text-center text-muted">Loading...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        const base = window.location.origin;

        var sidebar = document.getElementById('dashboardSidebar');
        var backdrop = document.getElementById('sidebarBackdrop');

        function closeSidebar() {
            sidebar.classList.remove('sidebar-open');
            backdrop.classList.remove('show');
            backdrop.setAttribute('aria-hidden', 'true');
        }

        function openSidebar() {
            sidebar.classList.add('sidebar-open');
            backdrop.classList.add('show');
            backdrop.setAttribute('aria-hidden', 'false');
        }

        function toggleSidebar() {
            if (sidebar.classList.contains('sidebar-open')) {
                closeSidebar();
            } else {
                openSidebar();
            }
        }

        document.getElementById('sidebarToggle').addEventListener('click', function() {
            toggleSidebar();
        });

        // Toggle token visibility (password <-> text); when showing, load full token if currently masked
        (function() {
            var input = document.getElementById('botToken');
            var btn = document.getElementById('btnToggleTokenVisibility');
            var iconEye = document.getElementById('iconTokenEye');
            var iconEyeSlash = document.getElementById('iconTokenEyeSlash');
            btn.addEventListener('click', async function() {
                if (input.type === 'password') {
                    // If value is masked (e.g. 9276***VBfc), fetch full token from server
                    if ((input.value || '').indexOf('***') !== -1) {
                        try {
                            var r = await fetch(base + '/api/settings/token?reveal=true');
                            var data = await r.json().catch(function() { return {}; });
                            if (r.ok && data.token) {
                                input.value = data.token;
                            }
                        } catch (_) {}
                    }
                    input.type = 'text';
                    iconEye.style.display = 'none';
                    iconEyeSlash.style.display = '';
                    btn.setAttribute('title', 'Hide token');
                } else {
                    input.type = 'password';
                    iconEye.style.display = '';
                    iconEyeSlash.style.display = 'none';
                    btn.setAttribute('title', 'Show token');
                }
            });
        })();

        backdrop.addEventListener('click', function() {
            closeSidebar();
        });

        // Tab switching (Users / Bot Operations)
        document.querySelectorAll('.sidebar-nav [data-tab]').forEach(function(link) {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                var tab = this.getAttribute('data-tab');
                document.querySelectorAll('.sidebar-nav .nav-link').forEach(function(l) { l.classList.remove('active'); });
                this.classList.add('active');
                document.querySelectorAll('.dashboard-section[id^="section-"]').forEach(function(s) {
                    s.style.display = s.id === 'section-' + tab ? 'block' : 'none';
                });
                if (tab === 'users') loadUsers();
                if (tab === 'stages') loadStages();
                if (tab === 'permissions') loadPermissions();
                if (tab === 'kyc') loadKyc();
            });
        });

        // Load users list
        function loadUsers() {
            fetch(base + '/api/users')
                .then(function(r) { return r.json(); })
                .then(function(data) {
                    var tbody = document.getElementById('usersTableBody');
                    if (Array.isArray(data)) {
                        if (data.length === 0) {
                            tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">No users yet. Users will appear after they interact with the bot.</td></tr>';
                        } else {
                            tbody.innerHTML = data.map(function(u) {
                                var firstSeen = u.firstSeenAt ? new Date(u.firstSeenAt).toLocaleString('en-GB', {dateStyle:'short', timeStyle:'short'}) : '—';
                                var lastSeen = u.lastSeenAt ? new Date(u.lastSeenAt).toLocaleString('en-GB', {dateStyle:'short', timeStyle:'short'}) : '—';
                                return '<tr><td><code>' + escapeHtml(String(u.telegramUserId)) + '</code></td><td>' + (u.username ? '@' + escapeHtml(u.username) : '—') + '</td><td>' + escapeHtml(u.firstName || '—') + '</td><td>' + escapeHtml(u.lastName || '—') + '</td><td><small>' + escapeHtml(firstSeen) + '</small></td><td><small>' + escapeHtml(lastSeen) + '</small></td><td><button class="btn btn-sm btn-outline-primary" onclick="viewUserMessages(' + u.telegramUserId + ')">Messages</button></td></tr>';
                            }).join('');
                        }
                    } else {
                        tbody.innerHTML = '<tr><td colspan="7" class="text-center text-danger">Error loading users</td></tr>';
                    }
                })
                .catch(function() {
                    document.getElementById('usersTableBody').innerHTML = '<tr><td colspan="7" class="text-center text-danger">Error loading users</td></tr>';
                });
        }

        document.getElementById('btnRefreshUsers').addEventListener('click', loadUsers);

        // View user messages
        window.viewUserMessages = function(userId) {
            var modal = new bootstrap.Modal(document.getElementById('messagesModal'));
            document.getElementById('messagesModalLabel').textContent = 'Messages for User ' + userId;
            document.getElementById('messagesModalContent').innerHTML = '<div class="text-center text-muted">Loading...</div>';
            modal.show();
            
            fetch(base + '/api/messages/conversation/' + userId + '?limit=5')
                .then(function(r) { return r.json(); })
                .then(function(messages) {
                    var content = document.getElementById('messagesModalContent');
                    if (Array.isArray(messages) && messages.length > 0) {
                        var html = '<div class="table-responsive"><table class="table table-sm table-hover"><thead class="table-dark"><tr><th>Time</th><th>From</th><th>Type</th><th>Text</th><th>Status</th><th>Actions</th></tr></thead><tbody>';
                        messages.reverse().forEach(function(m) {
                            var timeStr = m.sentAt ? new Date(m.sentAt).toLocaleString('en-GB', {dateStyle:'short', timeStyle:'short'}) : '—';
                            var fromBadge = m.isFromBot ? '<span class="badge bg-primary">Bot</span>' : '<span class="badge bg-success">User</span>';
                            var statusBadges = [];
                            if (m.editedAt) statusBadges.push('<span class="badge bg-warning text-dark">Edited</span>');
                            if (m.deletedAt) statusBadges.push('<span class="badge bg-danger">Deleted</span>');
                            if (m.hasInlineKeyboard) statusBadges.push('<span class="badge bg-info">Keyboard</span>');
                            if (m.shouldEdit) statusBadges.push('<span class="badge bg-secondary">Should Edit</span>');
                            if (m.shouldDelete) statusBadges.push('<span class="badge bg-danger">Should Delete</span>');
                            if (m.shouldKeepForEdit) statusBadges.push('<span class="badge bg-warning">Keep for Edit</span>');
                            var statusHtml = statusBadges.length > 0 ? statusBadges.join(' ') : '—';
                            var textPreview = m.text ? (m.text.length > 50 ? escapeHtml(m.text.substring(0, 50)) + '...' : escapeHtml(m.text)) : '—';
                            html += '<tr><td><small>' + escapeHtml(timeStr) + '</small></td><td>' + fromBadge + '</td><td><small>' + escapeHtml(m.messageType || '—') + '</small></td><td>' + textPreview + '</td><td>' + statusHtml + '</td><td><button class="btn btn-sm btn-outline-info" onclick="viewMessageState(' + userId + ',' + m.id + ')">State</button></td></tr>';
                        });
                        html += '</tbody></table></div>';
                        content.innerHTML = html;
                    } else {
                        content.innerHTML = '<div class="text-center text-muted">No messages found for this user.</div>';
                    }
                })
                .catch(function() {
                    document.getElementById('messagesModalContent').innerHTML = '<div class="text-center text-danger">Error loading messages</div>';
                });
        };

        // View message state
        window.viewMessageState = function(userId, messageId) {
            fetch(base + '/api/messages/user/' + userId + '/state')
                .then(function(r) { return r.json(); })
                .then(function(data) {
                    var lines = [];
                    if (data.lastMessage) {
                        lines.push('<strong>Last Bot Message:</strong>');
                        lines.push('ID: ' + data.lastMessage.id);
                        lines.push('Telegram ID: ' + data.lastMessage.telegramMessageId);
                        lines.push('Text: ' + (data.lastMessage.text || '—'));
                        lines.push('Sent: ' + new Date(data.lastMessage.sentAt).toLocaleString());
                        if (data.lastMessage.editedAt) lines.push('Edited: ' + new Date(data.lastMessage.editedAt).toLocaleString());
                        if (data.lastMessage.deletedAt) lines.push('Deleted: ' + new Date(data.lastMessage.deletedAt).toLocaleString());
                    }
                    if (data.state) {
                        lines.push('<br><strong>State:</strong>');
                        lines.push('Should Edit: ' + (data.state.shouldEdit ? 'Yes' : 'No'));
                        lines.push('Should Reply: ' + (data.state.shouldReply ? 'Yes' : 'No'));
                        lines.push('Should Keep Static: ' + (data.state.shouldKeepStatic ? 'Yes' : 'No'));
                        lines.push('Delete Next Messages: ' + (data.state.deleteNextMessages ? 'Yes' : 'No'));
                        lines.push('Last Action: ' + (data.state.lastAction || '—'));
                        if (data.state.lastActionAt) lines.push('Last Action At: ' + new Date(data.state.lastActionAt).toLocaleString());
                    }
                    Swal.fire({
                        icon: 'info',
                        title: 'Message State',
                        html: '<div class="text-start" style="line-height:1.8;">' + lines.join('<br>') + '</div>',
                        confirmButtonText: 'OK'
                    });
                })
                .catch(function() {
                    Swal.fire({ icon: 'error', title: 'Error', text: 'Failed to load message state' });
                });
        };

        document.addEventListener('click', function(event) {
            if (!sidebar.classList.contains('sidebar-open')) return;
            if (sidebar.contains(event.target)) return;
            if (event.target.closest('#sidebarToggle')) return;
            closeSidebar();
        });

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text ?? '';
            return div.innerHTML;
        }

        // Load webhook info (URL + last sync for label)
        async function loadWebhookInfo() {
            try {
                const r = await fetch(base + '/api/webhook/info');
                const data = await r.json().catch(() => ({}));
                if (r.ok && data.url) {
                    document.getElementById('webhookUrl').value = data.url;
                }
            } catch (_) {}
            try {
                const s = await fetch(base + '/api/dashboard/status');
                const st = await s.json().catch(() => ({}));
                if (s.ok && st.webhookSyncedAt) {
                    const d = new Date(st.webhookSyncedAt);
                    document.getElementById('webhookSyncedLabel').textContent = 'Webhook synced: ' + d.toLocaleString('en-GB', { dateStyle: 'short', timeStyle: 'short' });
                }
            } catch (_) {}
        }

        // Load token into input (so it stays after refresh)
        async function loadTokenIntoInput() {
            try {
                const r = await fetch(base + '/api/settings/token');
                const data = await r.json().catch(function() { return {}; });
                var input = document.getElementById('botToken');
                if (r.ok && data.set && data.masked) {
                    input.value = data.masked;
                    input.placeholder = 'Token is set (replace to change)';
                } else {
                    input.value = '';
                    input.placeholder = '123456789:ABCdef...';
                }
            } catch (_) {
                document.getElementById('botToken').value = '';
            }
        }

        // Load update mode (Webhook / GetUpdates)
        async function loadUpdateMode() {
            try {
                const r = await fetch(base + '/api/settings/update-mode');
                const data = await r.json().catch(function() { return {}; });
                if (r.ok && data.mode) {
                    var mode = (data.mode || 'Webhook').trim();
                    document.getElementById('updateModeWebhook').checked = (mode !== 'GetUpdates');
                    document.getElementById('updateModeGetUpdates').checked = (mode === 'GetUpdates');
                }
            } catch (_) {}
        }

        // Load connection status (Token / Webhook / Bot / Services)
        async function loadConnectionStatus() {
            var tokenEl = document.getElementById('statusToken');
            var webhookEl = document.getElementById('statusWebhook');
            var botEl = document.getElementById('statusBot');
            var botTimeEl = document.getElementById('statusBotTime');
            var redisEl = document.getElementById('statusRedis');
            var rabbitMqEl = document.getElementById('statusRabbitMq');
            var sqlEl = document.getElementById('statusSql');
            try {
                const r = await fetch(base + '/api/dashboard/status');
                const st = await r.json().catch(() => ({}));
                if (!r.ok) {
                    tokenEl.textContent = '—';
                    var modeEl = document.getElementById('statusUpdateMode');
                    if (modeEl) modeEl.textContent = '—';
                    webhookEl.textContent = '—';
                    botEl.textContent = '—';
                    redisEl.textContent = '—';
                    rabbitMqEl.textContent = '—';
                    sqlEl.textContent = '—';
                    botTimeEl.textContent = '';
                    return;
                }
                tokenEl.textContent = st.tokenSet ? 'Set' : 'Not set';
                tokenEl.className = 'badge ' + (st.tokenSet ? 'bg-success' : 'bg-secondary');
                var modeEl = document.getElementById('statusUpdateMode');
                if (modeEl) {
                    modeEl.textContent = st.updateMode || 'Webhook';
                    modeEl.className = 'badge bg-info';
                }
                webhookEl.textContent = st.webhookSyncedAt ? 'Synced' : 'Not set';
                webhookEl.className = 'badge ' + (st.webhookSyncedAt ? 'bg-success' : 'bg-secondary');
                
                // Redis status
                redisEl.textContent = st.redisConnected ? 'Connected' : 'Not configured';
                redisEl.className = 'badge ' + (st.redisConnected ? 'bg-success' : 'bg-secondary');
                
                // RabbitMQ status
                rabbitMqEl.textContent = st.rabbitMqConfigured ? 'Configured' : 'Not configured';
                rabbitMqEl.className = 'badge ' + (st.rabbitMqConfigured ? 'bg-success' : 'bg-secondary');
                
                // SQL Server status
                sqlEl.textContent = st.sqlConnected ? 'Connected' : 'Not configured';
                sqlEl.className = 'badge ' + (st.sqlConnected ? 'bg-success' : 'bg-secondary');
                
                if (st.lastEventAt) {
                    var active = st.lastEventStatus === 'Received';
                    botEl.textContent = active ? 'Connected' : 'Last error';
                    botEl.className = 'badge ' + (active ? 'bg-success' : 'bg-danger');
                    botTimeEl.textContent = 'Last activity: ' + new Date(st.lastEventAt).toLocaleString('en-GB', { dateStyle: 'short', timeStyle: 'short' });
                    if (st.lastEventError && !active) botTimeEl.textContent += ' — ' + (st.lastEventError.length > 60 ? st.lastEventError.substring(0, 60) + '…' : st.lastEventError);
                } else {
                    botEl.textContent = 'No activity yet';
                    botEl.className = 'badge bg-secondary';
                    botTimeEl.textContent = 'Send a message to the bot to see activity.';
                }
            } catch (_) {
                tokenEl.textContent = '—';
                var modeEl = document.getElementById('statusUpdateMode');
                if (modeEl) modeEl.textContent = '—';
                webhookEl.textContent = '—';
                botEl.textContent = '—';
                redisEl.textContent = '—';
                rabbitMqEl.textContent = '—';
                sqlEl.textContent = '—';
                botTimeEl.textContent = '';
            }
        }

        // Save configuration (token + update mode)
        document.getElementById('credentialsForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            var token = (document.getElementById('botToken').value || '').trim();
            const mode = document.getElementById('updateModeGetUpdates').checked ? 'GetUpdates' : 'Webhook';
            
            // اگر توکن ماسک‌شده است (شامل ***)، آن را نفرست - فقط حالت را ذخیره کن
            var tokenIsNew = token && token.indexOf('***') === -1;
            
            try {
                // فقط اگر توکن جدید وارد شده، آن را ذخیره کن
                if (tokenIsNew) {
                    const r = await fetch(base + '/api/settings/token', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ token })
                    });
                    const data = await r.json().catch(() => ({}));
                    if (!r.ok) throw new Error(data.detail || data.message || 'Error');
                }
                
                // همیشه حالت به‌روزرسانی را ذخیره کن
                const modeRes = await fetch(base + '/api/settings/update-mode', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ mode })
                });
                const modeData = await modeRes.json().catch(() => ({}));
                if (!modeRes.ok) throw new Error(modeData.detail || 'Failed to save mode');
                
                Swal.fire({ icon: 'success', title: 'Saved.', text: 'Restart the application for changes to take effect.', timer: 5000, showConfirmButton: true });
                loadTokenIntoInput();
                loadUpdateMode();
                loadWebhookInfo();
                loadConnectionStatus();
            } catch (err) {
                Swal.fire({ icon: 'error', title: 'Error', text: err.message });
            }
        });

        document.getElementById('btnTestToken').addEventListener('click', async function() {
            try {
                const r = await fetch(base + '/api/bot/me');
                const data = await r.json().catch(() => ({}));
                if (r.ok) {
                    var lines = [
                        '<strong>Name:</strong> ' + (data.firstName || '') + (data.lastName ? ' ' + data.lastName : ''),
                        '<strong>Username:</strong> ' + (data.username ? '@' + data.username : '—'),
                        '<strong>Bot ID:</strong> ' + (data.id ?? '—'),
                        '<strong>Is Bot:</strong> ' + (data.isBot ? 'Yes' : 'No'),
                        (data.languageCode ? '<strong>Language:</strong> ' + data.languageCode : '')
                    ].filter(Boolean);
                    Swal.fire({
                        icon: 'success',
                        title: 'Bot Information',
                        html: '<div class="text-start" style="line-height:1.8;">' + lines.join('<br>') + '</div>',
                        confirmButtonText: 'OK'
                    });
                } else {
                    Swal.fire({ icon: 'error', title: 'Invalid token', text: data.detail || 'Could not find bot with this token.' });
                }
            } catch (err) {
                Swal.fire({ icon: 'error', title: 'Error', text: err.message });
            }
        });

        document.getElementById('btnSetWebhook').addEventListener('click', async function() {
            const url = (document.getElementById('webhookUrl').value || '').trim();
            if (!url) {
                Swal.fire({ icon: 'warning', title: 'Webhook URL is required.', timer: 2000, showConfirmButton: false });
                return;
            }
            if (!url.startsWith('https://')) {
                Swal.fire({ icon: 'warning', title: 'URL must start with https://', timer: 2000, showConfirmButton: false });
                return;
            }
            try {
                const r = await fetch(base + '/api/webhook/set', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url })
                });
                const data = await r.json().catch(() => ({}));
                if (!r.ok) throw new Error(data.detail || data.message || 'Error');
                Swal.fire({ icon: 'success', title: 'Webhook updated successfully.', timer: 2500, showConfirmButton: false });
                loadWebhookInfo();
                loadConnectionStatus();
            } catch (err) {
                Swal.fire({ icon: 'error', title: 'Error', text: err.message });
            }
        });

        function refreshWebhookMessages() {
            fetch(base + '/api/webhook/logs')
                .then(function(r) { return r.json(); })
                .then(function(list) {
                    const tbody = document.getElementById('webhookMessagesTable');
                    if (Array.isArray(list) && list.length > 0) {
                        tbody.innerHTML = list.map(function(msg) {
                            const statusClass = msg.status === 'Received' ? 'success' : (msg.status === 'Error' ? 'danger' : 'info');
                            const sourceClass = msg.source === 'Webhook' ? 'primary' : 'secondary';
                            const timeStr = msg.time ? new Date(msg.time).toLocaleString('en-GB', {dateStyle:'short', timeStyle:'short'}) : '';
                            
                            // Services badges
                            var services = [];
                            if (msg.redisProcessed) services.push('<span class="badge bg-danger me-1" title="Redis">R</span>');
                            if (msg.rabbitMqPublished) services.push('<span class="badge bg-warning text-dark me-1" title="RabbitMQ">MQ</span>');
                            if (msg.sqlProcessed) services.push('<span class="badge bg-info me-1" title="SQL Server">SQL</span>');
                            var servicesHtml = services.length > 0 ? services.join('') : '<span class="text-muted">-</span>';
                            
                            // Response sent
                            var replyHtml = msg.responseSent 
                                ? '<span class="badge bg-success">Yes</span>' 
                                : '<span class="badge bg-secondary">No</span>';
                            
                            // Handler name
                            var handlerHtml = msg.handlerName 
                                ? '<code class="small">' + escapeHtml(msg.handlerName.replace('Handler','')) + '</code>' 
                                : '<span class="text-muted">-</span>';
                            
                            return '<tr>' +
                                '<td><small>' + escapeHtml(timeStr) + '</small></td>' +
                                '<td><span class="badge bg-' + sourceClass + '">' + escapeHtml(msg.source || 'Unknown') + '</span></td>' +
                                '<td><span class="badge bg-' + statusClass + '">' + escapeHtml(msg.status) + '</span></td>' +
                                '<td>' + handlerHtml + '</td>' +
                                '<td>' + servicesHtml + '</td>' +
                                '<td>' + replyHtml + '</td>' +
                                '<td>' + (msg.error ? '<small class="text-danger" title="' + escapeHtml(msg.error) + '">' + escapeHtml(msg.error.length > 20 ? msg.error.substring(0,20) + '...' : msg.error) + '</small>' : '-') + '</td>' +
                                '</tr>';
                        }).join('');
                    } else {
                        tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">No updates yet</td></tr>';
                    }
                })
                .catch(function() {
                    document.getElementById('webhookMessagesTable').innerHTML = '<tr><td colspan="7" class="text-center text-danger">Error loading messages</td></tr>';
                });
        }

        document.getElementById('btnRefreshLogs').addEventListener('click', refreshWebhookMessages);

        var PUBLIC_WEBHOOK_URL = 'https://webhook.abroadqs.com/webhook';
        function updateWebhookUrlHint() {
            var isNgrok = document.getElementById('webhookSourceNgrok').checked;
            var isTunnel = document.getElementById('webhookSourceTunnel').checked;
            var input = document.getElementById('webhookUrl');
            var hint = document.getElementById('webhookUrlHint');
            if (isTunnel) {
                input.value = PUBLIC_WEBHOOK_URL;
                input.placeholder = PUBLIC_WEBHOOK_URL;
                hint.textContent = 'Fixed tunnel URL.';
            } else if (isNgrok) {
                input.placeholder = 'https://xxxx-xx-xx-xx-xx.ngrok-free.app/webhook';
                hint.textContent = 'Your Ngrok public URL (HTTPS). Use the URL Ngrok gives you.';
            } else {
                input.placeholder = PUBLIC_WEBHOOK_URL;
                hint.textContent = 'Server webhook URL (HTTPS). Use this URL when published on the server.';
            }
        }
        document.getElementById('webhookSourceServer').addEventListener('change', updateWebhookUrlHint);
        document.getElementById('webhookSourceTunnel').addEventListener('change', updateWebhookUrlHint);
        document.getElementById('webhookSourceNgrok').addEventListener('change', updateWebhookUrlHint);

        // Bot Status - Load and Toggle
        async function loadBotStatus() {
            try {
                const r = await fetch(base + '/api/bot/status');
                const data = await r.json().catch(() => ({}));
                updateBotStatusUI(data.enabled);
            } catch (_) {
                updateBotStatusUI(null);
            }
        }

        function updateBotStatusUI(enabled) {
            var label = document.getElementById('botStatusLabel');
            var btn = document.getElementById('btnBotToggle');
            var btnText = document.getElementById('btnBotToggleText');
            
            if (enabled === true) {
                label.textContent = 'Running';
                label.className = 'badge bg-success';
                btn.className = 'btn btn-danger';
                btnText.textContent = 'Stop';
            } else if (enabled === false) {
                label.textContent = 'Stopped';
                label.className = 'badge bg-secondary';
                btn.className = 'btn btn-success';
                btnText.textContent = 'Start';
            } else {
                label.textContent = '—';
                label.className = 'badge bg-secondary';
            }
        }

        document.getElementById('btnBotToggle').addEventListener('click', async function() {
            try {
                const r = await fetch(base + '/api/bot/toggle', { method: 'POST' });
                const data = await r.json().catch(() => ({}));
                if (r.ok) {
                    updateBotStatusUI(data.enabled);
                    Swal.fire({
                        icon: data.enabled ? 'success' : 'info',
                        title: data.enabled ? 'Bot Started' : 'Bot Stopped',
                        text: data.enabled ? 'Bot will now respond to messages.' : 'Bot will ignore incoming messages.',
                        timer: 2000,
                        showConfirmButton: false
                    });
                }
            } catch (err) {
                Swal.fire({ icon: 'error', title: 'Error', text: err.message });
            }
        });

        // ===== Bot Stages =====
        let currentStageId = null;
        let currentStageKey = null;

        async function loadStages() {
            try {
                const r = await fetch(base + '/api/stages');
                const stages = await r.json();
                const body = document.getElementById('stagesBody');
                body.innerHTML = stages.map(s => `<tr>
                    <td><code>${s.stageKey}</code></td>
                    <td style="max-width:200px;overflow:hidden;text-overflow:ellipsis">${esc(s.textFa||'')}</td>
                    <td style="max-width:200px;overflow:hidden;text-overflow:ellipsis">${esc(s.textEn||'')}</td>
                    <td>${s.isEnabled ? '<span class="badge bg-success">Yes</span>' : '<span class="badge bg-secondary">No</span>'}</td>
                    <td>${esc(s.requiredPermission||'—')}</td>
                    <td>${esc(s.parentStageKey||'—')}</td>
                    <td>${s.sortOrder}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="editStage(${s.id},'${s.stageKey}',\`${esc(s.textFa||'')}\`,\`${esc(s.textEn||'')}\`,${s.isEnabled},'${s.requiredPermission||''}','${s.parentStageKey||''}',${s.sortOrder})">Edit</button>
                        <button class="btn btn-sm btn-outline-info" onclick="showButtons(${s.id},'${s.stageKey}')">Buttons</button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteStage(${s.id})">Del</button>
                    </td></tr>`).join('');
            } catch(e) { console.error(e); }
        }

        function esc(s) { return s ? s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;') : ''; }

        document.getElementById('btnAddStage').addEventListener('click', async () => {
            const { value: formValues } = await Swal.fire({
                title: 'Add Stage', html:
                    '<input id="sKey" class="swal2-input" placeholder="Stage Key (e.g. main_menu)">' +
                    '<textarea id="sFa" class="swal2-textarea" placeholder="Text FA (HTML)"></textarea>' +
                    '<textarea id="sEn" class="swal2-textarea" placeholder="Text EN (HTML)"></textarea>' +
                    '<input id="sPerm" class="swal2-input" placeholder="Required Permission (empty=public)">' +
                    '<input id="sParent" class="swal2-input" placeholder="Parent Stage Key (for back button)">' +
                    '<input id="sOrder" class="swal2-input" type="number" value="0" placeholder="Sort Order">',
                focusConfirm: false, preConfirm: () => ({
                    stageKey: document.getElementById('sKey').value,
                    textFa: document.getElementById('sFa').value,
                    textEn: document.getElementById('sEn').value,
                    isEnabled: true,
                    requiredPermission: document.getElementById('sPerm').value || null,
                    parentStageKey: document.getElementById('sParent').value || null,
                    sortOrder: parseInt(document.getElementById('sOrder').value) || 0
                })
            });
            if (!formValues || !formValues.stageKey) return;
            try {
                await fetch(base + '/api/stages', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(formValues) });
                loadStages();
            } catch(e) { Swal.fire('Error', e.message, 'error'); }
        });

        async function editStage(id, key, fa, en, enabled, perm, parent, order) {
            const { value: formValues } = await Swal.fire({
                title: 'Edit: ' + key, html:
                    `<textarea id="sFa" class="swal2-textarea" placeholder="Text FA">${fa}</textarea>` +
                    `<textarea id="sEn" class="swal2-textarea" placeholder="Text EN">${en}</textarea>` +
                    `<label class="swal2-checkbox-label"><input id="sEnabled" type="checkbox" ${enabled?'checked':''}/> Enabled</label>` +
                    `<input id="sPerm" class="swal2-input" placeholder="Required Permission" value="${perm}">` +
                    `<input id="sParent" class="swal2-input" placeholder="Parent Stage Key" value="${parent}">` +
                    `<input id="sOrder" class="swal2-input" type="number" value="${order}">`,
                focusConfirm: false, preConfirm: () => ({
                    textFa: document.getElementById('sFa').value,
                    textEn: document.getElementById('sEn').value,
                    isEnabled: document.getElementById('sEnabled').checked,
                    requiredPermission: document.getElementById('sPerm').value || '',
                    parentStageKey: document.getElementById('sParent').value || '',
                    sortOrder: parseInt(document.getElementById('sOrder').value) || 0
                })
            });
            if (!formValues) return;
            try {
                await fetch(base + '/api/stages/' + id, { method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify(formValues) });
                loadStages();
            } catch(e) { Swal.fire('Error', e.message, 'error'); }
        }

        async function deleteStage(id) {
            const r = await Swal.fire({ title: 'Delete stage?', icon:'warning', showCancelButton:true, confirmButtonText:'Delete' });
            if (!r.isConfirmed) return;
            await fetch(base + '/api/stages/' + id, { method:'DELETE' });
            loadStages();
        }

        // ===== Stage Buttons =====
        async function showButtons(stageId, stageKey) {
            currentStageId = stageId;
            currentStageKey = stageKey;
            document.getElementById('stageButtonsPanel').style.display = 'block';
            document.getElementById('stageButtonsTitle').textContent = 'Buttons for: ' + stageKey;
            await loadButtons();
        }

        async function loadButtons() {
            if (!currentStageKey) return;
            try {
                const r = await fetch(base + '/api/stages/' + currentStageKey + '/buttons');
                const buttons = await r.json();
                const body = document.getElementById('buttonsBody');
                body.innerHTML = buttons.map(b => `<tr>
                    <td>${esc(b.textFa||'')}</td><td>${esc(b.textEn||'')}</td><td>${b.buttonType}</td>
                    <td><code>${esc(b.callbackData||'')}</code></td><td>${esc(b.targetStageKey||'')}</td>
                    <td>${esc(b.url||'')}</td><td>${b.row}</td><td>${b.column}</td>
                    <td>${b.isEnabled?'Y':'N'}</td><td>${esc(b.requiredPermission||'')}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="editButton(${b.id})">Edit</button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteButton(${b.id})">Del</button>
                    </td></tr>`).join('');
            } catch(e) { console.error(e); }
        }

        document.getElementById('btnAddButton').addEventListener('click', async () => {
            if (!currentStageId) return;
            const { value: fv } = await Swal.fire({
                title: 'Add Button', html:
                    '<input id="bFa" class="swal2-input" placeholder="Text FA">' +
                    '<input id="bEn" class="swal2-input" placeholder="Text EN">' +
                    '<select id="bType" class="swal2-select"><option value="callback">callback</option><option value="url">url</option></select>' +
                    '<input id="bCb" class="swal2-input" placeholder="Callback Data (e.g. stage:settings)">' +
                    '<input id="bTarget" class="swal2-input" placeholder="Target Stage Key">' +
                    '<input id="bUrl" class="swal2-input" placeholder="URL (for url buttons)">' +
                    '<input id="bRow" class="swal2-input" type="number" value="0" placeholder="Row">' +
                    '<input id="bCol" class="swal2-input" type="number" value="0" placeholder="Column">' +
                    '<input id="bPerm" class="swal2-input" placeholder="Required Permission">',
                focusConfirm: false, preConfirm: () => ({
                    textFa: document.getElementById('bFa').value, textEn: document.getElementById('bEn').value,
                    buttonType: document.getElementById('bType').value,
                    callbackData: document.getElementById('bCb').value || null,
                    targetStageKey: document.getElementById('bTarget').value || null,
                    url: document.getElementById('bUrl').value || null,
                    row: parseInt(document.getElementById('bRow').value)||0,
                    column: parseInt(document.getElementById('bCol').value)||0,
                    isEnabled: true, requiredPermission: document.getElementById('bPerm').value || null
                })
            });
            if (!fv) return;
            await fetch(base + '/api/stages/' + currentStageId + '/buttons', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(fv) });
            loadButtons();
        });

        async function editButton(btnId) {
            const { value: fv } = await Swal.fire({
                title: 'Edit Button #' + btnId, html:
                    '<input id="bFa" class="swal2-input" placeholder="Text FA">' +
                    '<input id="bEn" class="swal2-input" placeholder="Text EN">' +
                    '<input id="bCb" class="swal2-input" placeholder="Callback Data">' +
                    '<input id="bTarget" class="swal2-input" placeholder="Target Stage Key">' +
                    '<input id="bRow" class="swal2-input" type="number" placeholder="Row">' +
                    '<input id="bCol" class="swal2-input" type="number" placeholder="Column">' +
                    '<label class="swal2-checkbox-label"><input id="bEnabled" type="checkbox" checked/> Enabled</label>',
                focusConfirm: false, preConfirm: () => ({
                    textFa: document.getElementById('bFa').value || null,
                    textEn: document.getElementById('bEn').value || null,
                    callbackData: document.getElementById('bCb').value || null,
                    targetStageKey: document.getElementById('bTarget').value || null,
                    row: parseInt(document.getElementById('bRow').value) || null,
                    column: parseInt(document.getElementById('bCol').value) || null,
                    isEnabled: document.getElementById('bEnabled').checked
                })
            });
            if (!fv) return;
            await fetch(base + '/api/buttons/' + btnId, { method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify(fv) });
            loadButtons();
        }

        async function deleteButton(btnId) {
            const r = await Swal.fire({ title: 'Delete button?', icon:'warning', showCancelButton:true });
            if (!r.isConfirmed) return;
            await fetch(base + '/api/buttons/' + btnId, { method:'DELETE' });
            loadButtons();
        }

        // ===== Permissions =====
        async function loadPermissions() {
            try {
                const r = await fetch(base + '/api/permissions');
                const perms = await r.json();
                document.getElementById('permissionsBody').innerHTML = perms.map(p => `<tr>
                    <td><code>${p.permissionKey}</code></td><td>${esc(p.nameFa||'')}</td>
                    <td>${esc(p.nameEn||'')}</td><td>${esc(p.description||'')}</td>
                    <td><button class="btn btn-sm btn-outline-danger" onclick="deletePerm('${p.permissionKey}')">Del</button></td></tr>`).join('');
            } catch(e) { console.error(e); }
        }

        document.getElementById('btnAddPermission').addEventListener('click', async () => {
            const { value: fv } = await Swal.fire({
                title: 'Add Permission', html:
                    '<input id="pKey" class="swal2-input" placeholder="Permission Key">' +
                    '<input id="pFa" class="swal2-input" placeholder="Name FA">' +
                    '<input id="pEn" class="swal2-input" placeholder="Name EN">' +
                    '<input id="pDesc" class="swal2-input" placeholder="Description">',
                focusConfirm: false, preConfirm: () => ({
                    permissionKey: document.getElementById('pKey').value,
                    nameFa: document.getElementById('pFa').value || null,
                    nameEn: document.getElementById('pEn').value || null,
                    description: document.getElementById('pDesc').value || null
                })
            });
            if (!fv || !fv.permissionKey) return;
            await fetch(base + '/api/permissions', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(fv) });
            loadPermissions();
        });

        async function deletePerm(key) {
            const r = await Swal.fire({ title: 'Delete permission ' + key + '?', icon:'warning', showCancelButton:true });
            if (!r.isConfirmed) return;
            await fetch(base + '/api/permissions/' + key, { method:'DELETE' });
            loadPermissions();
        }

        // ===== User Permissions =====
        let currentPermUserId = null;
        document.getElementById('btnLoadUserPerms').addEventListener('click', async () => {
            currentPermUserId = parseInt(document.getElementById('userPermUserId').value);
            if (!currentPermUserId) return;
            document.getElementById('userPermsPanel').style.display = 'block';
            await loadUserPerms();
        });

        async function loadUserPerms() {
            if (!currentPermUserId) return;
            try {
                const r = await fetch(base + '/api/users/' + currentPermUserId + '/permissions');
                const perms = await r.json();
                document.getElementById('userPermsBody').innerHTML = perms.map(p => `<tr>
                    <td><code>${p.permissionKey}</code></td><td>${new Date(p.grantedAt).toLocaleString()}</td>
                    <td><button class="btn btn-sm btn-outline-danger" onclick="revokeUserPerm('${p.permissionKey}')">Revoke</button></td></tr>`).join('');
            } catch(e) { console.error(e); }
        }

        document.getElementById('btnGrantPerm').addEventListener('click', async () => {
            if (!currentPermUserId) return;
            const key = document.getElementById('grantPermKey').value.trim();
            if (!key) return;
            await fetch(base + '/api/users/' + currentPermUserId + '/permissions/' + key, { method:'POST' });
            document.getElementById('grantPermKey').value = '';
            loadUserPerms();
        });

        async function revokeUserPerm(key) {
            if (!currentPermUserId) return;
            await fetch(base + '/api/users/' + currentPermUserId + '/permissions/' + key, { method:'DELETE' });
            loadUserPerms();
        }

        // ===== KYC Review =====
        async function loadKyc() {
            var filter = document.getElementById('kycFilter').value;
            var url = filter === 'all' ? base + '/api/kyc/all' : base + '/api/kyc/pending';
            try {
                const r = await fetch(url);
                const data = await r.json();
                const tbody = document.getElementById('kycTableBody');
                if (Array.isArray(data) && data.length > 0) {
                    tbody.innerHTML = data.map(function(u) {
                        var name = escapeHtml((u.firstName || '') + ' ' + (u.lastName || '')).trim() || '—';
                        var statusBadge = u.kycStatus === 'pending_review'
                            ? '<span class="badge bg-warning text-dark">Pending</span>'
                            : u.kycStatus === 'approved'
                            ? '<span class="badge bg-success">Approved</span>'
                            : u.kycStatus === 'rejected'
                            ? '<span class="badge bg-danger">Rejected</span>'
                            : '<span class="badge bg-secondary">' + escapeHtml(u.kycStatus || 'none') + '</span>';
                        return '<tr>' +
                            '<td><code>' + u.telegramUserId + '</code></td>' +
                            '<td>' + name + '</td>' +
                            '<td>' + escapeHtml(u.phoneNumber || '—') + '</td>' +
                            '<td>' + escapeHtml(u.email || '—') + (u.emailVerified ? ' <span class="badge bg-success">V</span>' : '') + '</td>' +
                            '<td>' + escapeHtml(u.country || '—') + '</td>' +
                            '<td>' + statusBadge + '</td>' +
                            '<td>' +
                                '<button class="btn btn-sm btn-outline-info me-1" onclick="viewKycDetail(' + u.telegramUserId + ')">View</button>' +
                                (u.kycStatus === 'pending_review' ? '<button class="btn btn-sm btn-success me-1" onclick="approveKyc(' + u.telegramUserId + ')">Approve</button><button class="btn btn-sm btn-danger" onclick="rejectKycDialog(' + u.telegramUserId + ')">Reject</button>' : '') +
                            '</td></tr>';
                    }).join('');
                } else {
                    tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">No submissions found.</td></tr>';
                }
            } catch(e) {
                document.getElementById('kycTableBody').innerHTML = '<tr><td colspan="7" class="text-center text-danger">Error loading KYC data</td></tr>';
            }
        }

        document.getElementById('btnRefreshKyc').addEventListener('click', loadKyc);
        document.getElementById('kycFilter').addEventListener('change', loadKyc);

        window.viewKycDetail = async function(userId) {
            var modal = new bootstrap.Modal(document.getElementById('kycDetailModal'));
            document.getElementById('kycDetailTitle').textContent = 'KYC Details - User ' + userId;
            document.getElementById('kycDetailBody').innerHTML = '<div class="text-center text-muted">Loading...</div>';
            document.getElementById('kycDetailFooter').innerHTML = '';
            modal.show();

            try {
                const r = await fetch(base + '/api/kyc/' + userId);
                const u = await r.json();
                if (!r.ok) throw new Error(u.detail || 'Error');

                var statusBadge = u.kycStatus === 'approved' ? '<span class="badge bg-success">Approved</span>'
                    : u.kycStatus === 'pending_review' ? '<span class="badge bg-warning text-dark">Pending Review</span>'
                    : u.kycStatus === 'rejected' ? '<span class="badge bg-danger">Rejected</span>'
                    : '<span class="badge bg-secondary">' + escapeHtml(u.kycStatus||'none') + '</span>';

                var html = '<div class="row">' +
                    '<div class="col-md-6">' +
                    '<table class="table table-sm">' +
                    '<tr><th>Telegram ID</th><td><code>' + u.telegramUserId + '</code></td></tr>' +
                    '<tr><th>Username</th><td>' + (u.username ? '@' + escapeHtml(u.username) : '—') + '</td></tr>' +
                    '<tr><th>Name</th><td>' + escapeHtml((u.firstName||'') + ' ' + (u.lastName||'')) + '</td></tr>' +
                    '<tr><th>Phone</th><td>' + escapeHtml(u.phoneNumber || '—') + '</td></tr>' +
                    '<tr><th>Email</th><td>' + escapeHtml(u.email || '—') + (u.emailVerified ? ' <span class="badge bg-success">Verified</span>' : '') + '</td></tr>' +
                    '<tr><th>Country</th><td>' + escapeHtml(u.country || '—') + '</td></tr>' +
                    '<tr><th>Status</th><td>' + statusBadge + '</td></tr>' +
                    '</table>' +
                    (u.kycRejectionData ? '<div class="alert alert-danger"><strong>Rejection Reasons:</strong><br>' + escapeHtml(u.kycRejectionData) + '</div>' : '') +
                    '</div>' +
                    '<div class="col-md-6 text-center">' +
                    '<h6>Verification Photo</h6>' +
                    '<div id="kycPhotoContainer"><div class="text-muted">Loading photo...</div></div>' +
                    '</div></div>';

                document.getElementById('kycDetailBody').innerHTML = html;

                // Load photo
                if (u.verificationPhotoFileId) {
                    try {
                        const pr = await fetch(base + '/api/kyc/' + userId + '/photo');
                        const pd = await pr.json();
                        if (pr.ok && pd.photoUrl) {
                            document.getElementById('kycPhotoContainer').innerHTML =
                                '<img src="' + pd.photoUrl + '" class="img-fluid rounded" style="max-height:400px;" alt="Verification Photo" />';
                        } else {
                            document.getElementById('kycPhotoContainer').innerHTML = '<div class="text-muted">Could not load photo</div>';
                        }
                    } catch(e) {
                        document.getElementById('kycPhotoContainer').innerHTML = '<div class="text-muted">Photo load error</div>';
                    }
                } else {
                    document.getElementById('kycPhotoContainer').innerHTML = '<div class="text-muted">No photo uploaded</div>';
                }

                // Footer buttons
                if (u.kycStatus === 'pending_review') {
                    document.getElementById('kycDetailFooter').innerHTML =
                        '<button class="btn btn-success" onclick="approveKyc(' + userId + ')">Approve</button> ' +
                        '<button class="btn btn-danger" onclick="rejectKycDialog(' + userId + ')">Reject</button>';
                }
            } catch(e) {
                document.getElementById('kycDetailBody').innerHTML = '<div class="text-center text-danger">' + escapeHtml(e.message) + '</div>';
            }
        };

        window.approveKyc = async function(userId) {
            const confirm = await Swal.fire({
                title: 'Approve KYC?',
                text: 'Approve identity verification for user ' + userId + '?',
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'Approve',
                confirmButtonColor: '#28a745'
            });
            if (!confirm.isConfirmed) return;
            try {
                const r = await fetch(base + '/api/kyc/' + userId + '/approve', { method: 'POST' });
                const data = await r.json();
                if (!r.ok) throw new Error(data.detail || data.error || 'Error');
                Swal.fire({ icon: 'success', title: 'Approved', text: 'User has been verified and notified.', timer: 2500 });
                loadKyc();
                // Close modal if open
                try { bootstrap.Modal.getInstance(document.getElementById('kycDetailModal'))?.hide(); } catch(_){}
            } catch(e) {
                Swal.fire({ icon: 'error', title: 'Error', text: e.message });
            }
        };

        window.rejectKycDialog = async function(userId) {
            var fieldOptions = [
                { field: 'name', label: 'Name' },
                { field: 'phone', label: 'Phone' },
                { field: 'email', label: 'Email' },
                { field: 'country', label: 'Country' },
                { field: 'photo', label: 'Verification Photo' }
            ];

            var fieldsHtml = fieldOptions.map(function(f) {
                return '<div class="form-check mb-2">' +
                    '<input class="form-check-input" type="checkbox" id="reject_' + f.field + '" value="' + f.field + '">' +
                    '<label class="form-check-label" for="reject_' + f.field + '">' + f.label + '</label>' +
                    '<input type="text" class="form-control form-control-sm mt-1" id="reason_' + f.field + '" placeholder="Reason for rejection..." style="display:none;">' +
                    '</div>';
            }).join('');

            var { value: result } = await Swal.fire({
                title: 'Reject KYC - User ' + userId,
                html: '<p class="text-start">Select fields to reject and provide reasons:</p>' +
                    '<div class="text-start">' + fieldsHtml + '</div>',
                showCancelButton: true,
                confirmButtonText: 'Reject',
                confirmButtonColor: '#dc3545',
                didOpen: function() {
                    fieldOptions.forEach(function(f) {
                        document.getElementById('reject_' + f.field).addEventListener('change', function() {
                            document.getElementById('reason_' + f.field).style.display = this.checked ? 'block' : 'none';
                        });
                    });
                },
                preConfirm: function() {
                    var reasons = {};
                    var hasAny = false;
                    fieldOptions.forEach(function(f) {
                        if (document.getElementById('reject_' + f.field).checked) {
                            var reason = document.getElementById('reason_' + f.field).value.trim() || 'Rejected';
                            reasons[f.field] = reason;
                            hasAny = true;
                        }
                    });
                    if (!hasAny) {
                        Swal.showValidationMessage('Select at least one field to reject');
                        return false;
                    }
                    return reasons;
                }
            });

            if (!result) return;

            try {
                const r = await fetch(base + '/api/kyc/' + userId + '/reject', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ reasons: result })
                });
                const data = await r.json();
                if (!r.ok) throw new Error(data.detail || data.error || 'Error');
                Swal.fire({ icon: 'info', title: 'Rejected', text: 'User has been notified with rejection reasons.', timer: 2500 });
                loadKyc();
                try { bootstrap.Modal.getInstance(document.getElementById('kycDetailModal'))?.hide(); } catch(_){}
            } catch(e) {
                Swal.fire({ icon: 'error', title: 'Error', text: e.message });
            }
        };

        loadTokenIntoInput();
        loadUpdateMode();
        loadWebhookInfo();
        loadConnectionStatus();
        loadBotStatus();
        loadUsers();
        refreshWebhookMessages();
        setInterval(refreshWebhookMessages, 10000);
        setInterval(loadConnectionStatus, 15000);
        setInterval(loadBotStatus, 5000);
    </script>
</body>
</html>
